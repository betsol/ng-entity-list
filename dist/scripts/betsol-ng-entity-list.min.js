/**
 * betsol-ng-entity-list - Automatic entity lists for Angular.js
 * @version v0.0.4
 * @link https://github.com/betsol/ng-entity-list
 * @license MIT
 *
 * @author Slava Fomin II <s.fomin@betsol.ru>
 */
!function(window,angular,moment){"use strict";function normalizeScheme(e){return e=angular.extend({},defaultScheme,e),angular.forEach(e.fields,function(t,n){t=angular.extend({},defaultField,t),applyTransformers(t,n),e.fields[n]=t}),e}function applyTransformers(e,t){angular.forEach(fieldTransformers,function(n){if(e.type==n.type){if("function"!=typeof n.transformer)return console.log("Missing transformer function"),void 0;n.transformer(e,t)}})}function getDefaultFormatters(){var e={};return e.default=function(e){return e},e.email=function(e){return e.toLowerCase()},e.skype=function(e){return e.toLowerCase()},e.date=function(e,t){return moment&&moment.isMoment(e)?e.format(t.format||"D.M.YY"):e instanceof Date?e.toString():void 0},e.datetime=function(e,t){return moment&&moment.isMoment(e)?e.format(t.format||"DD.MM.YY HH:mm:ss"):e instanceof Date?e.toString():void 0},e}var defaultScheme={title:"",fields:{},add:!0,edit:!0,"delete":!0},defaultField={title:"",type:"string"},defaultItemsPerPage=50,fieldTransformers=[];angular.module("betsol.entityList",["ui.router","betsol.paginator"]).factory("EntityList",["Paginator","$state",function(Paginator,$state){return function(config){var defaultConfig={scope:null,baseStateName:"",repository:null,scheme:null,itemsPerPage:50,formatters:getDefaultFormatters(),criteria:{},sortParams:{},fieldTransformers:[]};if(config=angular.extend({},defaultConfig,config),!config.scope)return console.log("Missing scope");if(!config.baseStateName)return console.log("Missing base state name");if(!config.repository)return console.log("Missing repository");fieldTransformers=fieldTransformers.concat(config.fieldTransformers);var $scope=config.scope,repository=config.repository,scheme=normalizeScheme(config.scheme||{}),paginator=new Paginator(repository.find).setItemsPerPage(config.itemsPerPage||defaultItemsPerPage).setCriteria(config.criteria).setSorting(config.sortParams);paginator.first(),$scope.baseStateName=config.baseStateName,$scope.scheme=scheme,$scope.paginator=paginator,scheme.delete&&($scope.delete=function(e){window.confirm("Вы уверены, что хотите удалить «"+e.title+"»?")&&repository.delete(e.id).then(function(){paginator.first()}).catch(function(){alert("Не удалось удалить запись")})}),$scope.renderValue=function(entity,fieldName,field){var value=eval("entity."+fieldName),formatter=config.formatters[field.type]||config.formatters.default;return formatter(value,field)},$scope.getImageUrl=function(e,t){return"function"==typeof t.image.url?t.image.url(e):t.image.url},$scope.getClassNames=function(e,t){var n={};return t.classNames&&angular.forEach(t.classNames,function(t,r){n[r]="function"==typeof t?t(e):t}),n},$scope.getIconClassName=function(e,t){return"function"==typeof t.icon?t.icon(e):t.icon},$scope.getTooltip=function(e,t){return"function"==typeof t.tooltip?t.tooltip(e):t.tooltip},$scope.getLinkUrl=function(e,t){if(!t.link)return null;var n=t.link;if(n.stateName){var r={};return"function"==typeof n.params&&(r=n.params(e)),$state.href(n.stateName,r)}return n.url?"function"==typeof n.url?n.url(e):n.url:null}}}]).directive("entityField",function(){return{restrict:"E",scope:!1,templateUrl:"field.html"}}),fieldTransformers.push({type:"email",transformer:function(field,fieldName){field.link||(field.link={url:function(entity){return"mailto:"+eval("entity."+fieldName)}})}}),fieldTransformers.push({type:"skype",transformer:function(field,fieldName){field.link||(field.link={url:function(entity){return"skype:"+eval("entity."+fieldName)+"?chat"}})}})}(window,angular,window.moment);