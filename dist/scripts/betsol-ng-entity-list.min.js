/**
 * betsol-ng-entity-list - Automatic entity lists for Angular.js
 * @version v0.0.3
 * @link https://github.com/betsol/ng-entity-list
 * @license MIT
 *
 * @author Slava Fomin II <s.fomin@betsol.ru>
 */
!function(window,angular,moment){"use strict";function normalizeScheme(e){return e=angular.extend({},defaultScheme,e),angular.forEach(e.fields,function(t,n){e.fields[n]=angular.extend({},defaultField,t)}),e}function getDefaultFormatters(){var e={};return e.default=function(e){return e},e.date=function(e,t){return moment&&moment.isMoment(e)?e.format(t.format||"D.M.YY"):e instanceof Date?e.toString():void 0},e.datetime=function(e,t){return moment&&moment.isMoment(e)?e.format(t.format||"DD.MM.YY HH:mm:ss"):e instanceof Date?e.toString():void 0},e}var defaultScheme={title:"",fields:{},add:!0,edit:!0,"delete":!0},defaultField={title:"",type:"string"},defaultItemsPerPage=50;angular.module("betsol.entityList",["ui.router","betsol.paginator"]).factory("EntityList",["Paginator",function(Paginator){return function(config){var defaultConfig={scope:null,baseStateName:"",repository:null,scheme:null,itemsPerPage:50,formatters:getDefaultFormatters(),criteria:{},sortParams:{}};if(config=angular.extend({},defaultConfig,config),!config.scope)return console.log("Missing scope");if(!config.baseStateName)return console.log("Missing base state name");if(!config.repository)return console.log("Missing repository");var $scope=config.scope,repository=config.repository,scheme=normalizeScheme(config.scheme||{}),paginator=new Paginator(repository.find).setItemsPerPage(config.itemsPerPage||defaultItemsPerPage).setCriteria(config.criteria).setSorting(config.sortParams);paginator.first(),$scope.baseStateName=config.baseStateName,$scope.scheme=scheme,$scope.paginator=paginator,scheme.delete&&($scope.delete=function(e){window.confirm("Вы уверены, что хотите удалить «"+e.title+"»?")&&repository.delete(e.id).then(function(){paginator.first()}).catch(function(){alert("Не удалось удалить запись")})}),$scope.renderValue=function(entity,fieldName,field){var value=eval("entity."+fieldName),formatter=config.formatters[field.type]||config.formatters.default;return formatter(value,field)},$scope.getImageUrl=function(e,t){return"function"==typeof t?t(e):t},$scope.getLinkParams=function(e,t){var n={};return"function"==typeof t.params&&(n=t.params(e)),JSON.stringify(n)}}}])}(window,angular,window.moment);